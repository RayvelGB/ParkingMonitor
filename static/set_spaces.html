<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Zone Spaces</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="shortcut icon" href="/static/favicon.png" type="image/x-icon">
    <style>
        .hidden { display: none; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
            appearance: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8">
            <div class="flex items-center mb-4 md:mb-0">
                <i class="fas fa-hashtag text-blue-500 text-3xl mr-3"></i>
                <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-blue-400 to-blue-600 bg-clip-text text-transparent pb-1">
                    Set Zone Spaces
                </h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center bg-gray-800 px-4 py-2 rounded-lg">
                    <i class="fas fa-clock text-blue-400 mr-2"></i>
                    <span id="current-time" class="font-mono">00:00:00</span>
                </div>
                <!-- User Account Dropdown -->
                <div class="relative">
                    <button id="user-menu-button" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-lg font-semibold text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <span id="user-initial">?</span>
                    </button>
                    <div id="user-menu" class="dropdown-menu hidden absolute right-0 mt-2 w-56 origin-top-right bg-gray-800 rounded-md shadow-lg z-10">
                        <div class="py-1">
                            <div class="px-4 py-2 text-sm text-gray-300 border-b border-gray-700">
                                <p class="font-semibold">Signed in as</p>
                                <p id="user-name" class="truncate"></p>
                            </div>
                            <a href="/register_camera.html" id="manage-camera-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Manage Cameras</a>
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Log Out</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex justify-center">
            <div class="bg-gray-800 rounded-xl shadow-xl p-8 w-full max-w-2xl">
                <div class="mb-6">
                    <label for="camera-select" class="block text-sm font-medium text-gray-400 mb-2">Select a Camera to Manage</label>
                    <select id="camera-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-base">
                        <option value="">-- Please choose a camera --</option>
                    </select>
                </div>
                
                <div id="zone-management-section" class="hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Create New Zone</h3>
                        <div class="flex">
                            <input type="text" id="zone-name-input" placeholder="e.g., Visitor Parking" class="w-full bg-gray-700 border border-gray-600 rounded-l-lg px-3 py-2 text-sm">
                            <button id="add-zone-btn" class="bg-green-600 hover:bg-green-700 px-4 rounded-r-lg flex items-center transition">
                                <i class="fas fa-plus"></i> Add Zone
                            </button>
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold text-center mb-4">Manage Spaces for Each Zone</h2>
                    <div id="zone-list-container" class="space-y-4 mb-6 max-h-96 overflow-y-auto pr-4">
                        <p id="loading-text" class="text-center text-gray-400">Loading zones...</p>
                    </div>

                    <div class="mt-6 flex flex-col gap-2">
                        <button id="save-btn" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg flex items-center justify-center transition">
                            <i class="fas fa-save mr-2"></i> Save All Changes
                        </button>
                         <button id="back-to-stream-btn" class="w-full bg-gray-600 hover:bg-gray-700 py-2 rounded-lg flex items-center justify-center transition">
                            <i class="fas fa-arrow-left mr-2"></i> Back to Stream
                        </button>
                    </div>
                     <p id="status" class="text-center text-gray-400 min-h-[24px] mt-4"></p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>Smart Parking Monitoring System â€¢ v1.0.0</p>
        </footer>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            const userInitial = document.getElementById('user-initial');
            const userNameEl = document.getElementById('user-name');
            const logoutBtn = document.getElementById('logout-btn');
            const currentTimeEl = document.getElementById('current-time');

            const cameraSelect = document.getElementById('camera-select');
            const zoneManagementSection = document.getElementById('zone-management-section');
            const zoneListContainer = document.getElementById('zone-list-container');
            const loadingText = document.getElementById('loading-text');
            const saveBtn = document.getElementById('save-btn');
            const backBtn = document.getElementById('back-to-stream-btn');
            const statusEl = document.getElementById('status');
            const addZoneBtn = document.getElementById('add-zone-btn');
            const zoneNameInput = document.getElementById('zone-name-input');

            const user = JSON.parse(sessionStorage.getItem('user'));
            let selectedCameraId = null;

            if (!user) {
                window.location.href = '/';
                return;
            }

            // --- Populate User Menu ---
            if(user && user.username) {
                userInitial.textContent = user.username.charAt(0).toUpperCase();
                userNameEl.textContent = user.username;
            }

            userMenuButton.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevents the window click listener from firing immediately
                userMenu.classList.toggle('hidden');
            });

            // *** NEW: Close dropdown when clicking outside ***
            window.addEventListener('click', (event) => {
                if (!userMenu.classList.contains('hidden') && !userMenuButton.contains(event.target)) {
                    userMenu.classList.add('hidden');
                }
            });

            function logout() {
                sessionStorage.removeItem('user');
                window.location.href = '/';
            }

            logoutBtn.addEventListener('click', logout);

            function updateTime() { currentTimeEl.textContent = new Date().toLocaleTimeString(); }
            setInterval(updateTime, 1000);
            updateTime();

            function fetchCameras() {
                fetch(`/get_cameras/${user.user_id}`)
                    .then(res => res.json())
                    .then(cameras => {
                        if (cameras && cameras.length > 0) {
                            cameras.forEach(camera => {
                                if (camera.detection_type === 'tripwire') {
                                    const option = document.createElement('option');
                                    option.value = camera.id;
                                    option.textContent = camera.camera_name || `Camera ${camera.id.substring(0,8)}`;
                                    cameraSelect.appendChild(option);
                                }
                            });
                        }
                    });
            }

            function fetchZonesForCamera(cameraId) {
                if (!cameraId) return;
                zoneManagementSection.classList.remove('hidden');
                zoneListContainer.innerHTML = '<p id="loading-text" class="text-center text-gray-400">Loading zones...</p>';

                fetch(`/get_zones/${cameraId}`)
                    .then(res => res.json())
                    .then(zones => {
                        zoneListContainer.innerHTML = '';
                        if (!zones || zones.length === 0) {
                            zoneListContainer.innerHTML = '<p class="text-center text-gray-500">No zones created for this camera yet.</p>';
                            return;
                        }

                        zones.forEach(zone => {
                            const zoneDiv = document.createElement('div');
                            zoneDiv.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg';
                            zoneDiv.innerHTML = `
                                <div>
                                    <p class="font-semibold">${zone.zone_name}</p>
                                    <p class="text-xs text-gray-400">Zone ID: ${zone.id}</p>
                                </div>
                                <div class="flex items-center">
                                    <button class="decrement-btn bg-gray-600 hover:bg-gray-500 rounded-l-lg px-3 py-1 transition">-</button>
                                    <input type="number" min="0" value="${zone.total_spaces || 0}" 
                                           data-zone-id="${zone.id}"
                                           class="zone-space-input w-20 bg-gray-800 border-y border-gray-600 px-2 py-1 text-center font-bold">
                                    <button class="increment-btn bg-gray-600 hover:bg-gray-500 rounded-r-lg px-3 py-1 transition">+</button>
                                </div>
                            `;
                            zoneListContainer.appendChild(zoneDiv);
                        });

                        document.querySelectorAll('.increment-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const input = e.target.previousElementSibling;
                                input.stepUp();
                            });
                        });

                        document.querySelectorAll('.decrement-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const input = e.target.nextElementSibling;
                                input.stepDown();
                            });
                        });
                    });
            }

            cameraSelect.addEventListener('change', (e) => {
                selectedCameraId = e.target.value;
                fetchZonesForCamera(selectedCameraId);
            });

            addZoneBtn.addEventListener('click', () => {
                const zoneName = zoneNameInput.value.trim();
                if (!zoneName || !selectedCameraId) {
                    statusEl.textContent = "Please select a camera and enter a zone name.";
                    return;
                }
                
                fetch(`/create_zones/${selectedCameraId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ zone_name: zoneName, user_id: user.user_id })
                })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        zoneNameInput.value = '';
                        fetchZonesForCamera(selectedCameraId); // Refresh the list
                    } else {
                        statusEl.textContent = result.error || 'Failed to create zone.';
                    }
                });
            });

            // FIX: The logic for the save button has been added.
            saveBtn.addEventListener('click', () => {
                const inputs = document.querySelectorAll('.zone-space-input');
                const zoneData = [];
                
                inputs.forEach(input => {
                    const newTotalSpaces = parseInt(input.value, 10);
                    if (!isNaN(newTotalSpaces) && newTotalSpaces >= 0) {
                        zoneData.push({
                            id: parseInt(input.dataset.zoneId, 10),
                            spaces: newTotalSpaces
                        });
                    }
                });

                statusEl.textContent = 'Saving...';
                fetch(`/update_zone_spaces/${selectedCameraId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: user.user_id,
                        zone_data: zoneData
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        statusEl.textContent = 'Saved successfully!';
                        setTimeout(() => { statusEl.textContent = ''; }, 2000);
                    } else {
                        statusEl.textContent = result.error || 'Failed to save.';
                    }
                });
            });

            backBtn.addEventListener('click', () => {
                window.location.href = `/stream.html?camera_id=${selectedCameraId}`;
            });

            // Initial Load
            fetchCameras();
        });
    </script>
</body>
</html>
