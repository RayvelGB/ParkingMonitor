<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Camera Configuration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="shortcut icon" href="/static/favicon.png" type="image/x-icon">
    <style>
        .canvas-container {
            border: 1px solid #4b5563;
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: #000;
            width: 100%;
            max-height: 70vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            height: auto;
            width: auto;
            cursor: crosshair;
        }
        .zone-list-item.active { background-color: #3b82f6; color: white; }
        .hidden { display: none; }
        #box-mode-section {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        #box-mode-section.visible {
            max-height: 200px;
            opacity: 1;
        }
        #detection-type-toggle:checked ~ .dot {
            transform: translateX(1.75rem); /* Corresponds to w-14 in Tailwind */
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-white">Edit Camera Configuration</h1>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 bg-gray-800 px-3 py-1 rounded-full">
                    <span id="detection-type-label" class="text-gray-300 font-medium text-sm w-20 text-center">Tripwire</span>
                    <label for="detection-type-toggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="detection-type-toggle" class="sr-only">
                            <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                        </div>
                    </label>
                </div>

                <div class="flex items-center bg-gray-800 px-4 py-2 rounded-lg">
                    <i class="fas fa-clock text-blue-400 mr-2"></i>
                    <span id="current-time" class="font-mono">00:00:00</span>
                </div>
                <!-- User Account Dropdown -->
                <div class="relative">
                    <button id="user-menu-button" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-lg font-semibold text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <span id="user-initial">?</span>
                    </button>
                    <div id="user-menu" class="dropdown-menu hidden absolute right-0 mt-2 w-56 origin-top-right bg-gray-800 rounded-md shadow-lg z-10">
                        <div class="py-1">
                            <div class="px-4 py-2 text-sm text-gray-300 border-b border-gray-700">
                                <p class="font-semibold">Signed in as</p>
                                <p id="user-name" class="truncate"></p>
                            </div>
                            <a href="/register_camera.html" id="manage-camera-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Manage Cameras</a>
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Log Out</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Controls Panel -->
            <div class="lg:col-span-1 bg-gray-800 rounded-xl shadow-xl p-6 flex flex-col">
                <div>
                    <h2 class="text-xl font-bold mb-4">1. Manage Zones</h2>
                    <div class="mb-4">
                        <label for="zone-name-input" class="block text-sm font-medium text-gray-400 mb-2">New Zone Name</label>
                        <div class="flex">
                            <input type="text" id="zone-name-input" placeholder="e.g., Staff Parking" class="w-full bg-gray-700 border border-gray-600 rounded-l-lg px-3 py-2 text-sm">
                            <button id="add-zone-btn" class="bg-green-600 hover:bg-green-700 px-4 rounded-r-lg"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div id="zone-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>

                <div id="box-mode-section" class="mt-6">
                    <h2 class="text-xl font-bold mb-4">2. Set Line Mode</h2>
                     <div class="space-y-2 rounded-lg bg-gray-700 p-3">
                        <div class="flex items-center">
                            <input id="mode-entry" name="box-mode" type="radio" value="entry" checked class="h-4 w-4 text-green-500 bg-gray-600 border-gray-500 focus:ring-green-500">
                            <label for="mode-entry" class="ml-2 block text-sm font-medium text-green-400">Entry Line (Green)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="mode-exit" name="box-mode" type="radio" value="exit" class="h-4 w-4 text-red-500 bg-gray-600 border-gray-500 focus:ring-red-500">
                            <label for="mode-exit" class="ml-2 block text-sm font-medium text-red-400">Exit Line (Red)</label>
                        </div>
                    </div>
                </div>
                
                <div class="mt-auto pt-6 space-y-2">
                     <button id="undo-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 py-2 rounded-lg">Undo Point</button>
                     <button id="save-btn" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg">Save & Finish</button>
                     <button id="clear-btn" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg">Clear All Boxes</button>
                     <p id="status" class="text-center text-gray-400 min-h-[24px] mt-2"></p>
                </div>
            </div>

            <!-- Canvas -->
            <div class="lg:col-span-3 bg-gray-800 rounded-xl shadow-xl p-6 text-center">
                 <p id="canvas-status" class="text-gray-400 mb-4 text-lg">Select a zone, then click 4 points on the image to draw a box.</p>
                <div class="canvas-container inline-block">
                    <canvas id="canvas"></canvas>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            const userInitial = document.getElementById('user-initial');
            const userNameEl = document.getElementById('user-name');
            const logoutBtn = document.getElementById('logout-btn');
            const currentTimeEl = document.getElementById('current-time');

            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const statusEl = document.getElementById('status');
            const canvasStatusEl = document.getElementById('canvas-status');
            const zoneNameInput = document.getElementById('zone-name-input');
            const addZoneBtn = document.getElementById('add-zone-btn');
            const zoneListEl = document.getElementById('zone-list');
            const undoBtn = document.getElementById('undo-btn');
            const saveBtn = document.getElementById('save-btn');
            const clearBtn = document.getElementById('clear-btn');
            const detectionToggle = document.getElementById('detection-type-toggle');
            const detectionLabel = document.getElementById('detection-type-label');
            const boxModeSection = document.getElementById('box-mode-section');

            const urlParams = new URLSearchParams(window.location.search);
            const camera_id = urlParams.get('camera_id');
            const user = JSON.parse(sessionStorage.getItem('user'));

            let image = new Image();
            let currentPolygon = [];
            let parkingSpaces = [];
            let zones = {};
            let activeZoneId = null;
            const colorPalette = ['#3b82f6', '#f97316', '#8b5cf6', '#14b8a6', '#d946ef', '#22c55e'];

            if (!user || !camera_id) {
                statusEl.textContent = "Error: Missing user or camera ID.";
                return;
            }

            // --- Populate User Menu ---
            if(user && user.username) {
                userInitial.textContent = user.username.charAt(0).toUpperCase();
                userNameEl.textContent = user.username;
            }

            userMenuButton.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevents the window click listener from firing immediately
                userMenu.classList.toggle('hidden');
            });

            // *** NEW: Close dropdown when clicking outside ***
            window.addEventListener('click', (event) => {
                if (!userMenu.classList.contains('hidden') && !userMenuButton.contains(event.target)) {
                    userMenu.classList.add('hidden');
                }
            });

            function logout() {
                sessionStorage.removeItem('user');
                window.location.href = '/';
            }

            logoutBtn.addEventListener('click', logout);

            function updateTime() { currentTimeEl.textContent = new Date().toLocaleTimeString(); }
            setInterval(updateTime, 1000);
            updateTime();

            function getSelectedBoxMode() {
                return document.querySelector('input[name="box-mode"]:checked').value;
            }

            function redraw() {
                if (!image.src) return;
                ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                
                parkingSpaces.forEach((space) => {
                    const color = space.mode === 'entry' ? '#22c55e' : '#ef4444';
                    const zone = zones[space.zone_id];
                    
                    ctx.strokeStyle = color;
                    ctx.fillStyle = color + '33';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(space.points[0][0], space.points[0][1]);
                    for (let i = 1; i < space.points.length; i++) ctx.lineTo(space.points[i][0], space.points[i][1]);
                    ctx.closePath();
                    ctx.stroke();
                    ctx.fill();

                    if (zone) {
                        const centerX = space.points.reduce((sum, p) => sum + p[0], 0) / 4;
                        const centerY = space.points.reduce((sum, p) => sum + p[1], 0) / 4;
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 16px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(zone.name, centerX, centerY);
                    }
                });

                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.beginPath();
                currentPolygon.forEach(([x, y], i) => (i === 0) ? ctx.moveTo(x, y) : ctx.lineTo(x, y));
                ctx.stroke();

                ctx.fillStyle = '#ffffff';
                const allPoints = [...parkingSpaces.flatMap(s => s.points), ...currentPolygon];
                allPoints.forEach(([x, y]) => {
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
            }

            function renderZoneList() {
                zoneListEl.innerHTML = '';
                for (const zoneId in zones) {
                    const zone = zones[zoneId];
                    const button = document.createElement('div');
                    button.className = `w-full flex items-center justify-between p-2 rounded-lg text-left transition zone-list-item ${activeZoneId == zoneId ? 'active' : 'bg-gray-700 hover:bg-gray-600'}`;
                    button.innerHTML = `
                        <div class="flex items-center cursor-pointer flex-grow">
                            <div class="w-4 h-4 rounded-full mr-3" style="background-color: ${zone.color};"></div>
                            <span>${zone.name}</span>
                        </div>
                        <button data-zone-id="${zoneId}" class="delete-zone-btn text-gray-400 hover:text-white px-2">&times;</button>
                    `;
                    button.querySelector('.flex-grow').addEventListener('click', () => {
                        activeZoneId = zoneId;
                        renderZoneList();
                    });
                    zoneListEl.appendChild(button);
                }

                // Add event listeners for the new delete buttons
                document.querySelectorAll('.delete-zone-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const zoneIdToDelete = e.target.dataset.zoneId;
                        const zoneNameToDelete = zones[zoneIdToDelete].name;
                        if (confirm(`Are you sure you want to delete the "${zoneNameToDelete}" zone? All boxes assigned to it will be unassigned.`)) {
                            fetch(`/delete_zone/${zoneIdToDelete}`, {
                                method: 'DELETE',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ user_id: user.user_id })
                            })
                            .then(res => res.json())
                            .then(result => {
                                if (result.success) {
                                    // Remove from local state and re-render
                                    delete zones[zoneIdToDelete];
                                    if (activeZoneId == zoneIdToDelete) {
                                        activeZoneId = null;
                                    }
                                    parkingSpaces.forEach(space => {
                                        if (space.zone_id == zoneIdToDelete) {
                                            space.zone_id = null;
                                        }
                                    });
                                    renderZoneList();
                                    redraw();
                                } else {
                                    statusEl.textContent = result.error || 'Failed to delete zone.';
                                }
                            });
                        }
                    });
                });
            }

            detectionToggle.addEventListener('change', () => {
                if (detectionToggle.checked) {
                    detectionLabel.textContent = 'Parking';
                    boxModeSection.classList.remove('visible');
                } else {
                    detectionLabel.textContent = 'Tripwire';
                    boxModeSection.classList.add('visible');
                }
            });

            canvas.addEventListener('click', (e) => {
                if (!activeZoneId) {
                    canvasStatusEl.textContent = "Please select a zone from the list first!";
                    return;
                }
                
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                
                currentPolygon.push([x, y]);
                
                if (currentPolygon.length === 4) {
                    const mode = getSelectedBoxMode();
                    parkingSpaces.push({ points: currentPolygon, zone_id: activeZoneId, mode: mode });
                    currentPolygon = [];
                }
                redraw();
            });

            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault(); // Prevent the default browser context menu
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;

                // Find which box was clicked on, starting from the top-most one
                for (let i = parkingSpaces.length - 1; i >= 0; i--) {
                    const space = parkingSpaces[i];
                    ctx.beginPath();
                    ctx.moveTo(space.points[0][0], space.points[0][1]);
                    for (let j = 1; j < space.points.length; j++) ctx.lineTo(space.points[j][0], space.points[j][1]);
                    ctx.closePath();
                    if (ctx.isPointInPath(x, y)) {
                        parkingSpaces.splice(i, 1); // Remove the box from the array
                        redraw();
                        return; // Stop after deleting one box
                    }
                }
            });

            undoBtn.addEventListener('click', () => {
                if (currentPolygon.length > 0) {
                    currentPolygon.pop();
                } else if (parkingSpaces.length > 0) {
                    const lastSpace = parkingSpaces.pop();
                    currentPolygon = lastSpace.points;
                    currentPolygon.pop(); // Remove the last point from the now-current polygon
                }
                redraw();
            });

            saveBtn.addEventListener('click', () => {
                statusEl.textContent = 'Saving...';
                const selectedType = detectionToggle.checked ? 'parking' : 'tripwire';

                const saveBoxesPromise = fetch(`/save_bounding_boxes/${camera_id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({boxes: parkingSpaces, user_id: user.user_id})
                }).then(res => res.json());

                const saveTypePromise = fetch(`/set_detection_type/${camera_id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: user.user_id,
                        detection_type: selectedType
                    })
                }).then(res => res.json());

                Promise.all([saveBoxesPromise, saveTypePromise])
                    .then(([boxesResult, typeResult]) => {
                        if (boxesResult.success && typeResult.success) {
                            statusEl.textContent = 'Saved successfully! Redirecting...';
                            setTimeout(() => {
                               window.location.href = `/stream.html?camera_id=${camera_id}`;
                            }, 1500);
                        } else {
                            statusEl.textContent = 'Failed to save settings.';
                        }
                    });
            });
            
            clearBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all boxes?')) {
                    parkingSpaces = [];
                    currentPolygon = [];
                    redraw();
                }
            });

            addZoneBtn.addEventListener('click', () => {
                const zoneName = zoneNameInput.value.trim();
                if (zoneName) {
                    fetch(`/create_zones/${camera_id}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ zone_name: zoneName, user_id: user.user_id })
                    })
                    .then(res => res.json())
                    .then(result => {
                        if (result.success) {

                            const newZoneId = result.zone_id;
                            const colorIndex = Object.keys(zones).length % colorPalette.length;

                            zones[newZoneId] =  {
                                name: zoneName,
                                color: colorPalette[colorIndex]
                            };

                            renderZoneList();
                            zoneNameInput.value = '';
                            statusEl.textContent = `'${zoneName}' created.`;
                            setTimeout(() => {
                               statusEl.textContent = ''
                            }, 2000);
                        } else {
                            statusEl.textContent = result.error;
                        }
                    });
                }
            });

            async function initialize() {
                const frameResponse = await fetch(`/capture_frame/${camera_id}?user_id=${user.user_id}`);
                const blob = await frameResponse.blob();
                image.src = URL.createObjectURL(blob);
                await new Promise(resolve => image.onload = resolve);
                canvas.width = image.width;
                canvas.height = image.height;

                const zonesResponse = await fetch(`/get_zones/${camera_id}`);
                const zonesData = await zonesResponse.json();
                let colorIndex = 0;
                zones = {};
                zonesData.forEach(zone => {
                    zones[zone.id] = {
                        name: zone.zone_name,
                        color: colorPalette[colorIndex % colorPalette.length]
                    };
                    colorIndex++;
                });
                renderZoneList();

                const boxesResponse = await fetch(`/get_bounding_boxes/${camera_id}?user_id=${user.user_id}`);
                const boxesData = await boxesResponse.json();
                parkingSpaces = boxesData.bounding_boxes || [];
                
                redraw();
                statusEl.textContent = "Ready to edit.";

                // FIX: Corrected the fetch URL
                const detailsResponse = await fetch(`/get_detection_type/${camera_id}?user_id=${user.user_id}`);
                const details = await detailsResponse.json();
                if (details.detection_type === 'parking') {
                    detectionToggle.checked = true;
                } else {
                    detectionToggle.checked = false;
                }
                detectionToggle.dispatchEvent(new Event('change'));
            }

            initialize();
        });
    </script>
</body>
</html>
