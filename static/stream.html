<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="shortcut icon" href="/static/favicon.png" type="image/x-icon">
    <style>
        /* Custom scrollbar for logs */
        .log-container {
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }
        
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .log-container::-webkit-scrollbar-track {
            background: #1f2937;
        }
        
        .log-container::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        
        /* Animation for new log entries */
        @keyframes highlight {
            0% { background-color: rgba(59, 130, 246, 0.3); }
            100% { background-color: transparent; }
        }
        
        .log-entry.new {
            animation: highlight 1.5s ease-out;
        }

        .hidden {
            display: none !important;
        }

        /* Pulse animation for live indicator */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .live-indicator {
            animation: pulse-green 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8">
            <div class="flex items-center mb-4 md:mb-0">
                <i class="fas fa-car text-blue-500 text-3xl mr-3"></i>
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold bg-gradient-to-r from-blue-400 to-blue-600 bg-clip-text text-transparent pb-1">
                    Smart Parking Monitor
                </h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="flex items-center bg-gray-800 px-4 py-2 rounded-lg">
                    <i class="fas fa-clock text-blue-400 mr-2"></i>
                    <span id="current-time" class="font-mono">00:00:00</span>
                </div>
                <!-- User Account Dropdown -->
                <div class="relative">
                    <button id="user-menu-button" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-lg font-semibold text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <span id="user-initial">?</span>
                    </button>
                    <div id="user-menu" class="dropdown-menu hidden absolute right-0 mt-2 w-56 origin-top-right bg-gray-800 rounded-md shadow-lg z-10">
                        <div class="py-1">
                            <div class="px-4 py-2 text-sm text-gray-300 border-b border-gray-700">
                                <p class="font-semibold">Signed in as</p>
                                <p id="user-name" class="truncate"></p>
                            </div>
                            <a href="/register_camera.html" id="manage-camera-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Manage Cameras</a>
                            <a href="#" id="change-account-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Change Account</a>
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Log Out</a>
                        </div>
                    </div>
                </div>

                <div class="relative">
                    <button id="settings-menu-button" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-lg text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div id="settings-menu" class="dropdown-menu hidden absolute right-0 mt-2 w-72 origin-top-right bg-gray-800 rounded-md shadow-lg z-10 p-4">
                        <h3 class="text-lg font-semibold mb-4">Detection Settings</h3>
                        
                        <!-- Detection Threshold -->
                        <div class="mb-4">
                            <label for="detection-slider" class="flex justify-between text-sm font-medium text-gray-300">
                                <span>Detection Threshold</span>
                                <span id="detection-value">0.35</span>
                            </label>
                            <input id="detection-slider" type="range" min="0.1" max="0.9" step="0.05" value="0.35" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- IOU Threshold -->
                        <div id="iou-container" class="mb-4 transition-opaciy duration-300">
                            <label for="iou-slider" class="flex justify-between text-sm font-medium text-gray-300">
                                <span>IOU Threshold</span>
                                <span id="iou-value">0.30</span>
                            </label>
                            <input id="iou-slider" type="range" min="0.1" max="0.9" step="0.05" value="0.3" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- Confirmation Time Slider -->
                        <div class="mb-4">
                            <label for="confirmation-slider" class="flex justify-between text-sm font-medium text-gray-300">
                                <span>Confirmation Time (s)</span>
                                <span id="confirmation-value">5</span>
                            </label>
                            <input id="confirmation-slider" type="range" min="1" max="30" step="1" value="5" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- Intersection Only Checkbox -->
                        <div class="flex items-center mb-4">
                            <input id="intersection-checkbox" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                            <label for="intersection-checkbox" class="ml-2 text-sm font-medium text-gray-300">Use Intersection Only</label>
                        </div>

                        <button id="save-settings-btn" class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded-lg flex items-center justify-center transition">
                            Save Settings
                        </button>
                        <p id="settings-status" class="text-xs text-green-400 mt-2 h-4"></p>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Video Feed Section -->
            <div class="lg:col-span-2 bg-gray-800 rounded-xl overflow-hidden shadow-xl flex flex-col">
                <div class="p-4 bg-gray-700 flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-video mr-2 mt-0.5 text-blue-400"></i>
                        Live Parking Feed
                    </h2>
                    <div class="flex items-center gap-2">
                        <select id="camera-select" class="bg-gray-600 border-gray-500 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-1.5 cursor-pointer">
                            <option selected disabled>Change Camera...</option>
                        </select>
                        <button id="edit-bounds-btn" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-sm flex items-center flex-shrink-0">
                            <i class="fas fa-draw-polygon mr-2"></i> Edit Spaces
                        </button>
                        <button id="assign-zones-btn" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-sm flex items-center flex-shrink-0">
                            <i class="fas fa-layer-group mr-2"></i> Assign Zones
                        </button>
                        <button id="delete-camera-btn" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm flex items-center flex-shrink-0">
                            <i class="fas fa-trash mr-2"></i> Delete
                        </button>
                    </div>
                </div>
                
                <div class="relative flex-grow bg-black min-h-[400px]">
                    <div id="loader" class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin text-gray-500 text-5xl mb-4"></i>
                            <p class="text-gray-400">Initializing Camera Stream...</p>
                        </div>
                    </div>
                    <img id="video-feed" src="" alt="Live Video Feed" class="hidden absolute inset-0 w-full h-full object-contain">
                </div>
            </div>
            
            <!-- Stats Section -->
            <div class="space-y-6">
                <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-pie mr-2 mt-0.5 text-blue-400"></i>
                        Parking Occupancy
                    </h2>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-700 rounded-lg p-4 text-center">
                            <div id="total-spaces" class="text-3xl font-bold text-blue-400">--</div>
                            <div class="text-sm text-gray-400">Total Spaces</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4 text-center">
                            <div id="available-spaces" class="text-3xl font-bold text-green-400">--</div>
                            <div class="text-sm text-gray-400">Available</div>
                        </div>
                    </div>
                    <div class="relative pt-1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-medium text-blue-300">Occupancy</span>
                            <span id="occupancy-percent" class="text-xs font-medium text-blue-300">0%</span>
                        </div>
                        <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-700">
                            <div id="occupancy-bar" style="width:0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-blue-500 to-blue-600"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-broadcast-tower mr-2 mt-0.5 text-blue-400"></i>
                        System Status
                    </h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Camera ID:</span>
                            <span id="camera-id-display" class="font-mono text-gray-300 truncate">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Stream Status:</span>
                            <div id="stream-status-indicator" class="flex items-center">
                                <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                                <span class="font-medium text-gray-400">Connecting...</span>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Last Log Update:</span>
                            <span id="last-updated" class="font-mono text-gray-300">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Logs Section -->
        <div class="mt-8 bg-gray-800 rounded-xl overflow-hidden shadow-xl">
            <div class="p-4 bg-gray-700">
                <h2 class="text-lg font-semibold flex items-center text-white-300">
                    <i class="fas fa-clipboard-list mr-2 text-blue-400"></i>
                    Detection Logs
                </h2>
            </div>
            <div class="log-container max-h-64 overflow-y-auto rounded-b-xl">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-800 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-gray-400 uppercase tracking-wider">Time</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-gray-400 uppercase tracking-wider">Event</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-gray-400 uppercase tracking-wider">Zone / Slot</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-gray-400 uppercase tracking-wider">Details</th>
                        </tr>
                    </thead>
                    <tbody class="bg-gray-800 divide-y divide-gray-700" id="log-entries">
                        <!-- Log entries will be inserted here dynamically -->
                    </tbody>
                </table>
                <div class="text-sm text-gray-500 p-4 border-t border-gray-700">
                    Showing last 50 entries
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>Smart Parking Monitoring System • v1.0.0</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const loader = document.getElementById('loader');
            const videoFeed = document.getElementById('video-feed');
            const logTbody = document.getElementById('log-entries');
            const availableSpacesEl = document.getElementById('available-spaces');
            const totalSpacesEl = document.getElementById('total-spaces');
            const occupancyPercentEl = document.getElementById('occupancy-percent');
            const occupancyBarEl = document.getElementById('occupancy-bar');
            const editBoundsBtn = document.getElementById('edit-bounds-btn');
            const assignZonesBtn = document.getElementById('assign-zones-btn');
            const deleteCamBtn = document.getElementById('delete-camera-btn');
            const currentTimeEl = document.getElementById('current-time');
            const cameraIdDisplayEl = document.getElementById('camera-id-display');
            const lastUpdatedEl = document.getElementById('last-updated');
            const streamStatusIndicator = document.getElementById('stream-status-indicator');
            const cameraSelect = document.getElementById('camera-select');
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            const userInitial = document.getElementById('user-initial');
            const userNameEl = document.getElementById('user-name');
            const manageCamBtn = document.getElementById('manage-camera-btn');
            const changeAccountBtn = document.getElementById('change-account-btn');
            const logoutBtn = document.getElementById('logout-btn');

            const settingsMenuButton = document.getElementById('settings-menu-button');
            const settingsMenu = document.getElementById('settings-menu');
            const detectionSlider = document.getElementById('detection-slider');
            const detectionValue = document.getElementById('detection-value');
            const iouSlider = document.getElementById('iou-slider');
            const iouValue = document.getElementById('iou-value');
            const iouContainer = document.getElementById('iou-container');
            const confirmationSlider = document.getElementById('confirmation-slider');
            const confirmationValue = document.getElementById('confirmation-value');
            const intersectionCheckbox = document.getElementById('intersection-checkbox');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const settingsStatus = document.getElementById('settings-status');

            // --- Initial State & Auth ---
            const urlParams = new URLSearchParams(window.location.search);
            const camera_id = urlParams.get('camera_id');
            const user = JSON.parse(sessionStorage.getItem('user'));
            let totalParkingSpaces = null;
            let lastLogMessage = "";

            if (!user) {
                window.location.href = '/';
                return;
            }

            // --- UI Functions ---
            if(user && user.username) {
                userInitial.textContent = user.username.charAt(0).toUpperCase();
                userNameEl.textContent = user.username;
            }

            function updateTime() {
                currentTimeEl.textContent = new Date().toLocaleTimeString();
            }
            setInterval(updateTime, 1000);
            updateTime();

            function stopStream() {
                if (camera_id) {
                    navigator.sendBeacon('/stop_stream', JSON.stringify({ camera_id }));
                }
            }

            function logout() {
                stopStream();
                sessionStorage.removeItem('user');
                window.location.href = '/';
            }

            userMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                userMenu.classList.toggle('hidden');
            });
            window.addEventListener('click', () => {
                if (!userMenu.classList.contains('hidden')) userMenu.classList.add('hidden');
            });

            manageCamBtn.addEventListener('click', stopStream);
            logoutBtn.addEventListener('click', logout);
            changeAccountBtn.addEventListener('click', logout);

            function populateCameraSelector() {
                fetch(`/get_cameras/${user.user_id}`)
                    .then(response => response.json())
                    .then(cameras => {
                        cameraSelect.innerHTML = '<option selected disabled>Change Camera...</option>';
                        for (const id in cameras) {
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = cameras[id].camera_name || `Cam ${id.substring(0, 8)}...`;
                            if (id === camera_id) {
                                option.selected = true;
                            }
                            cameraSelect.appendChild(option);
                        }
                    })
                    .catch(err => console.error('Error fetching cameras:', err));
            }

            function fetchLogs() {
                fetch(`/get_logs/${camera_id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data || !Array.isArray(data.logs)) {
                            return;
                        }

                        const totalSpaces = data.total_spaces;
                        const occupiedSpaces = totalSpaces > 0 ? totalSpaces - data.available_slots : 0;
                        const occupancyPercent = totalSpaces > 0 ? Math.round((occupiedSpaces / totalSpaces) * 100) : 0;

                        totalSpacesEl.textContent = totalSpaces;
                        availableSpacesEl.textContent = data.available_slots;
                        occupancyPercentEl.textContent = `${occupancyPercent}%`;
                        occupancyBarEl.style.width = `${occupancyPercent}%`;

                        if (data.logs.length === 0) {
                             // If there are no logs, ensure the table is empty
                             if (lastLogMessage !== "") {
                                logTbody.innerHTML = '';
                                lastLogMessage = "";
                             }
                            return;
                        }

                        const newestLogFromServer = data.logs[data.logs.length - 1];

                        // --- Only update the log table if the content has changed ---
                        if (newestLogFromServer !== lastLogMessage) {
                            lastLogMessage = newestLogFromServer;

                            logTbody.innerHTML = ''; // Clear existing logs
                            data.logs.reverse().forEach(msg => {
                                let eventType = '', eventIcon = '', iconColor = '', slotText = '--', details = '';

                                if (msg.includes('OCCUPIED')) {
                                    eventType = 'Occupied'; eventIcon = 'fa-car'; iconColor = 'text-red-400';
                                    const match = msg.match(/\[(.*?)\] (?:(.*?) - )?Slot (\d+) OCCUPIED/);
                                    if (match) {
                                        const zone = match[2] ? `${match[2]} - ` : '';
                                        slotText = `${zone}Slot ${match[3]}`;
                                        details = `Vehicle detected at ${match[1]}`;
                                    }
                                } else if (msg.includes('VACATED')) {
                                    eventType = 'Vacated'; eventIcon = 'fa-car-side'; iconColor = 'text-green-400';
                                    const match = msg.match(/\[(.*?)\] (?:(.*?) - )?Slot (\d+) VACATED - Occupied for (.*)/);
                                    if (match) {
                                        const zone = match[2] ? `${match[2]} - ` : '';
                                        slotText = `${zone}Slot ${match[3]}`;
                                        details = `Occupied for ${match[4]}`;
                                    }
                                }

                                const timeMatch = msg.match(/\[(.*?)\]/);
                                const time = timeMatch ? timeMatch[1] : '00:00:00';

                                const logRow = document.createElement('tr');
                                logRow.className = 'hover:bg-gray-700';
                                logRow.innerHTML = `
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-center">${time}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center"><div class="inline-flex items-center"><i class="fas ${eventIcon} ${iconColor} mr-2"></i><span>${eventType}</span></div></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">${slotText}</td>
                                    <td class="px-6 py-4 text-sm text-gray-300 text-center">${details}</td>
                                `;
                                logTbody.appendChild(logRow);
                            });
                            
                            if (logTbody.firstChild) {
                                logTbody.firstChild.classList.add('new');
                                setTimeout(() => {
                                    if (logTbody.firstChild) {
                                        logTbody.firstChild.classList.remove('new');
                                    }
                                }, 1500);
                            }

                            lastUpdatedEl.textContent = new Date().toLocaleTimeString();
                        }
                    })
                    .catch(err => console.error('Error fetching logs:', err));
            }

            settingsMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                settingsMenu.classList.toggle('hidden');
            });

            window.addEventListener('click', (event) => {
                if (!settingsMenu.classList.contains('hidden') && !settingsMenuButton.contains(event.target) && !settingsMenu.contains(event.target)) {
                    settingsMenu.classList.add('hidden');
                }
            });

            detectionSlider.addEventListener('input', () => {
                detectionValue.textContent = parseFloat(detectionSlider.value).toFixed(2);
            });

            iouSlider.addEventListener('input', () => {
                iouValue.textContent = parseFloat(iouSlider.value).toFixed(2);
            });

            confirmationSlider.addEventListener('input', () => {
                confirmationValue.textContent = confirmationSlider.value;
            });

            function toggleIouSlider() {
                if (intersectionCheckbox.checked) {
                    iouContainer.classList.add('opacity-50');
                    iouSlider.disabled = true;
                } else {
                    iouContainer.classList.remove('opacity-50');
                    iouSlider.disabled = false;
                }
            }

            intersectionCheckbox.addEventListener('change', toggleIouSlider);

            function loadSettings() {
                if (!camera_id) return;
                fetch(`/get_settings/${camera_id}?user_id=${user.user_id}`)
                    .then(res => res.json())
                    .then(settings => {
                        detectionSlider.value = settings.detection_threshold;
                        detectionValue.textContent = parseFloat(settings.detection_threshold).toFixed(2);
                        iouSlider.value = settings.iou_threshold;
                        iouValue.textContent = parseFloat(settings.iou_threshold).toFixed(2);
                        confirmationSlider.value = settings.confirmation_time;
                        confirmationValue.textContent = settings.confirmation_time;
                        intersectionCheckbox.checked = settings.use_intersection_only;
                        toggleIouSlider();
                    });
            }

            saveSettingsBtn.addEventListener('click', () => {
                settingsStatus.textContent = 'Saving...';
                const settings = {
                    user_id: user.user_id,
                    detection_threshold: parseFloat(detectionSlider.value),
                    iou_threshold: parseFloat(iouSlider.value),
                    use_intersection_only: intersectionCheckbox.checked,
                    confirmation_time: parseInt(confirmationSlider.value)
                };
                fetch(`/save_settings/${camera_id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        settingsStatus.textContent = 'Settings saved successfully!';
                    } else {
                        settingsStatus.textContent = 'Error saving settings.';
                    }
                    setTimeout(() => settingsStatus.textContent = '', 2000);
                });
            });

            deleteCamBtn.addEventListener('click', () => {
                if (!camera_id) return;

                if (confirm('Are you sure you want to permanently delete this camera and all its data? This action cannot be undone.')) {
                    stopStream();

                    fetch(`/delete_camera/${camera_id}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ user_id: user.user_id })
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert('Camera deleted successfully.');
                            window.location.href = '/register_camera.html'
                        } else {
                            alert(`Error: ${result.error || 'Failed to delete camera.'}`);
                        }
                    })
                    .catch(err => {
                        console.error('Delete error:', err);
                        alert('An error occurred while trying to delete the camera.');
                    });
                }
            });

            // --- Main Execution ---
            if (!camera_id) {
                loader.innerHTML = '<div class="text-center"><i class="fas fa-video-slash text-gray-500 text-5xl mb-4"></i><p class="text-gray-400">Select a camera to begin.</p></div>';
                populateCameraSelector();
                return;
            }
            
            
            cameraIdDisplayEl.textContent = camera_id;
            populateCameraSelector();
            loadSettings();

            fetch('/start_stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ camera_id: camera_id, user_id: user.user_id })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    loader.classList.add('hidden');
                    videoFeed.classList.remove('hidden');
                    videoFeed.src = `/video_feed/${camera_id}`;
                    streamStatusIndicator.innerHTML = '<div class="w-2 h-2 bg-green-500 rounded-full mr-2 live-indicator"></div><span class="font-medium text-green-400">Online</span>';
                    
                    fetchLogs();
                    setInterval(fetchLogs, 2000);
                } else {
                    loader.innerHTML = `<div class="text-center"><i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i><p class="text-gray-400">Failed to start stream: ${result.error || 'Permission Denied'}</p></div>`;
                    streamStatusIndicator.innerHTML = '<div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div><span class="font-medium text-red-400">Offline</span>';
                }
            });

            // --- Event Listeners ---
            editBoundsBtn.addEventListener('click', () => {
                if (camera_id) {
                    window.location.href = `/picker.html?camera_id=${camera_id}`;
                }
            });

            assignZonesBtn.addEventListener('click', () => {
                if (camera_id) {
                    window.location.href = `/zone_picker.html?camera_id=${camera_id}`;
                }
            });

            cameraSelect.addEventListener('change', (e) => {
                const newCameraId = e.target.value;
                if (newCameraId && newCameraId !== camera_id) {
                    stopStream();
                    window.location.href = `/stream.html?camera_id=${newCameraId}`;
                }
            });

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && camera_id) {
                    videoFeed.src = `/video_feed/${camera_id}?t=${new Date().getTime()}`;
                }
            });
        });
    </script>
</body>
</html>
