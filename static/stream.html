<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="shortcut icon" href="/static/favicon.png" type="image/x-icon">
    <style>
        /* Custom scrollbar for logs */
        .log-container {
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }
        
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .log-container::-webkit-scrollbar-track {
            background: #1f2937;
        }
        
        .log-container::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }

        #zone-stats-container {
            scrollbar-width: thin;
            scrollbar-color: #4b5563 transparent;
        }
        
        #zone-stats-container::-webkit-scrollbar {
            width: 8px;
        }
        
        #zone-stats-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #zone-stats-container::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        
        /* Animation for new log entries */
        @keyframes highlight {
            0% { background-color: rgba(59, 130, 246, 0.3); }
            100% { background-color: transparent; }
        }
        
        .log-entry.new {
            animation: highlight 1.5s ease-out;
        }

        .hidden {
            display: none !important;
        }

        /* Pulse animation for live indicator */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .live-indicator {
            animation: pulse-green 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8">
            <div class="flex items-center mb-4 md:mb-0">
                <i class="fas fa-car text-blue-500 text-3xl mr-3"></i>
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold bg-gradient-to-r from-blue-400 to-blue-600 bg-clip-text text-transparent pb-1">
                    Smart Parking Monitor
                </h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="flex items-center bg-gray-800 px-4 py-2 rounded-lg">
                    <i class="fas fa-clock text-blue-400 mr-2"></i>
                    <span id="current-time" class="font-mono">00:00:00</span>
                </div>
                <!-- User Account Dropdown -->
                <div class="relative">
                    <button id="user-menu-button" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-lg font-semibold text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <span id="user-initial">?</span>
                    </button>
                    <div id="user-menu" class="dropdown-menu hidden absolute right-0 mt-2 w-56 origin-top-right bg-gray-800 rounded-md shadow-lg z-10">
                        <div class="py-1">
                            <div class="px-4 py-2 text-sm text-gray-300 border-b border-gray-700">
                                <p class="font-semibold">Signed in as</p>
                                <p id="user-name" class="truncate"></p>
                            </div>
                            <a href="/register_camera.html" id="manage-camera-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Manage Cameras</a>
                            <a href="#" id="change-account-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Change Account</a>
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Log Out</a>
                        </div>
                    </div>
                </div>

                <!-- Settings Dropdown -->
                <div class="relative">
                    <button id="settings-menu-button" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-lg text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div id="settings-menu" class="dropdown-menu hidden absolute right-0 mt-2 w-72 origin-top-right bg-gray-800 rounded-md shadow-lg z-10 p-4">
                        <h3 class="text-lg font-semibold mb-4">Detection Settings</h3>
                        
                        <!-- Detection Threshold -->
                        <div class="mb-4">
                            <label for="detection-slider" class="flex justify-between text-sm font-medium text-gray-300">
                                <span>Detection Threshold</span>
                                <span id="detection-value">0.35</span>
                            </label>
                            <input id="detection-slider" type="range" min="0.1" max="0.9" step="0.05" value="0.35" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <div id="parking-settings">
                            <!-- IOU Threshold -->
                            <div class="mb-4">
                                <label for="iou-slider" class="flex justify-between text-sm font-medium text-gray-300">
                                    <span>IOU Threshold</span>
                                    <span id="iou-value">0.3</span>
                                </label>
                                <input id="iou-slider" type="range" min="0.1" max="0.9" step="0.05" value="0.3" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            </div>

                            <!-- Confirmation Time Slider -->
                            <div class="mb-4">
                                <label for="confirmation-slider" class="flex justify-between text-sm font-medium text-gray-300">
                                    <span>Confirmation Time (s)</span>
                                    <span id="confirmation-value">5</span>
                                </label>
                                <input id="confirmation-slider" type="range" min="1" max="30" step="1" value="5" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div> 

                        <button id="save-settings-btn" class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded-lg flex items-center justify-center transition">
                            Save Settings
                        </button>
                        <p id="settings-status" class="text-xs text-green-400 mt-2 h-4"></p>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Video Feed Section -->
            <div class="lg:col-span-2 bg-gray-800 rounded-xl overflow-hidden shadow-xl flex flex-col">
                <div class="p-4 bg-gray-700 flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-video mr-2 mt-0.5 text-blue-400"></i>
                        Live Parking Feed
                    </h2>
                    <div class="flex items-center gap-2">
                        <div id="camera-carousel" class="flex items-center space-x-3 bg-gray-600 px-3 py-1.5 rounded-lg">
                            <button id="prev-camera-btn" class="text-white hover:text-blue-400 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="camera-name-display" class="font-semibold text-white text-sm w-40 text-center truncate" title="Camera Name">Loading...</span>
                            <button id="next-camera-btn" class="text-white hover:text-blue-400 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <button id="edit-bounds-btn" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-sm flex items-center flex-shrink-0">
                            <i class="fas fa-layer-group mr-2"></i> Edit Bounds
                        </button>
                        <div id="set-spaces">
                            <button id="set-spaces-btn" class="bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-sm flex items-center flex-shrink-0">
                            <i class="fas fa-draw-polygon mr-2"></i> Set Spaces
                            </button>
                        </div>
                        <button id="delete-camera-btn" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm flex items-center flex-shrink-0">
                            <i class="fas fa-trash mr-2"></i> Delete
                        </button>
                    </div>
                </div>
                
                <div class="relative flex-grow bg-black min-h-[400px]">
                    <div id="loader" class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin text-gray-500 text-5xl mb-4"></i>
                            <p class="text-gray-400">Initializing Camera Stream...</p>
                        </div>
                    </div>
                    <img id="video-feed" src="" alt="Live Video Feed" class="hidden absolute inset-0 w-full h-full object-contain">
                </div>
            </div>
            
            <!-- Stats Section -->
            <div class="space-y-6">
                <!-- All Camera Occupancy -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                    <h2 class="text-lg font-semibold mb-4">
                        <i class="fas fa-chart-pie mr-2 mt-0.5 text-blue-400"></i>
                        Overall Occupancy
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-700 rounded-lg p-4 text-center">
                            <div id="total-spaces" class="text-3xl font-bold text-blue-400">--</div>
                            <div class="text-sm text-gray-400">Total Spaces</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4 text-center">
                            <div id="available-spaces" class="text-3xl font-bold text-green-400">--</div>
                            <div class="text-sm text-gray-400">Available</div>
                        </div>
                    </div>
                    <div class="relative pt-1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-medium text-blue-300">Occupancy</span>
                            <span id="occupancy-percent" class="text-xs font-medium text-blue-300">0%</span>
                        </div>
                        <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-700">
                            <div id="occupancy-bar" style="width:0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-blue-500 to-blue-600"></div>
                        </div>
                    </div>
                </div> 

                <!-- Zone Stats -->
                <div id="zone-stats-container" class="space-y-6 max-h-[20vh] overflow-y-auto pr-2">
                    <!-- Zone cards will be inserted here by JavaScript -->
                </div>

                <!-- Additional Info -->
                <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-broadcast-tower mr-2 mt-0.5 text-blue-400"></i>
                        System Status
                    </h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Camera ID:</span>
                            <span id="camera-id-display" class="font-mono text-gray-300 truncate">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Stream Status:</span>
                            <div id="stream-status-indicator" class="flex items-center">
                                <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                                <span class="font-medium text-gray-400">Connecting...</span>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Detection Type:</span>
                            <span id="detection-type" class="font-mono text-gray-300">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Last Log Update:</span>
                            <span id="last-updated" class="font-mono text-gray-300">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Logs Section -->
        <div class="mt-8 bg-gray-800 rounded-xl overflow-hidden shadow-xl">
            <div class="p-4 bg-gray-700">
                <h2 class="text-lg font-semibold flex items-center text-white-300">
                    <i class="fas fa-clipboard-list mr-2 text-blue-400"></i>
                    Detection Logs
                </h2>
            </div>
            <div class="log-container max-h-64 overflow-y-auto rounded-b-xl">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-800 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-gray-400 uppercase tracking-wider">Time</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-gray-400 uppercase tracking-wider">Event</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-gray-400 uppercase tracking-wider">Location</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-semibold text-gray-400 uppercase tracking-wider">Details</th>
                        </tr>
                    </thead>
                    <tbody class="bg-gray-800 divide-y divide-gray-700" id="log-entries">
                        <!-- Log entries will be inserted here dynamically -->
                    </tbody>
                </table>
                <div class="text-sm text-gray-500 p-4 border-t border-gray-700">
                    Showing last 50 entries
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>Smart Parking Monitoring System • v1.0.0</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const loader = document.getElementById('loader');
            const videoFeed = document.getElementById('video-feed');
            const logTbody = document.getElementById('log-entries');

            // --- Stats Elements ---
            // Overall stats
            const availableSpacesEl = document.getElementById('available-spaces');
            const totalSpacesEl = document.getElementById('total-spaces');
            const occupancyPercentEl = document.getElementById('occupancy-percent');
            const occupancyBarEl = document.getElementById('occupancy-bar');
            const statsContainer = document.getElementById('stats-container');

            // Zone Stats
            const zoneStatsContainer = document.getElementById('zone-stats-container');
            const aggregateTotalEl = document.getElementById('aggregate-total-spaces');
            const aggregateAvailableEl = document.getElementById('aggregate-available-spaces');

            // Stream Status
            const currentTimeEl = document.getElementById('current-time');
            const cameraIdDisplayEl = document.getElementById('camera-id-display');
            const lastUpdatedEl = document.getElementById('last-updated');
            const streamStatusIndicator = document.getElementById('stream-status-indicator');
            const detectionTypeEl = document.getElementById('detection-type');
            
            // --- Buttons above feed ---
            const editBoundsBtn = document.getElementById('edit-bounds-btn');
            const setSpaces = document.getElementById('set-spaces');
            const setSpacesBtn = document.getElementById('set-spaces-btn');
            const deleteCamBtn = document.getElementById('delete-camera-btn');
            const prevCamBtn = document.getElementById('prev-camera-btn');
            const nextCamBtn = document.getElementById('next-camera-btn');
            const camNameDisplay = document.getElementById('camera-name-display');

            // --- User Popup Elements ---
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            const userInitial = document.getElementById('user-initial');
            const userNameEl = document.getElementById('user-name');
            const manageCamBtn = document.getElementById('manage-camera-btn');
            const changeAccountBtn = document.getElementById('change-account-btn');
            const logoutBtn = document.getElementById('logout-btn');

            // --- Settings Elements ---
            const settingsMenuButton = document.getElementById('settings-menu-button');
            const settingsMenu = document.getElementById('settings-menu');
            const parkingSettings = document.getElementById('parking-settings');
            const detectionSlider = document.getElementById('detection-slider');
            const detectionValue = document.getElementById('detection-value');
            const iouSlider = document.getElementById('iou-slider');
            const iouValue = document.getElementById('iou-value');
            const iouContainer = document.getElementById('iou-container');
            const confirmationSlider = document.getElementById('confirmation-slider');
            const confirmationValue = document.getElementById('confirmation-value');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const settingsStatus = document.getElementById('settings-status');

            // --- Initial State & Auth ---
            let currentCameraId = null;
            let detectionType = null;
            const urlParams = new URLSearchParams(window.location.search);
            const user = JSON.parse(sessionStorage.getItem('user'));
            let totalParkingSpaces = null;
            let lastLogMessage = "";
            let allCameras = [];
            let currentCameraIndex = -1;
            let logInterval;

            if (!user) {
                window.location.href = '/';
                return;
            }

            // --- UI Functions ---
            if(user && user.username) {
                userInitial.textContent = user.username.charAt(0).toUpperCase();
                userNameEl.textContent = user.username;
            }

            function updateTime() {
                currentTimeEl.textContent = new Date().toLocaleTimeString();
            }
            setInterval(updateTime, 1000);
            updateTime();

            function fetchStats(camId) {
                if (!camId) return;

                fetch('/get_aggregate_stats')
                    .then(res => res.json())
                    .then(data => {
                        if (data) {
                            const totalSpaces = data.total_spaces;
                            const availableSlotsDisplay = Math.min(Math.max(data.available_slots, 0), totalSpaces);
                            const occupiedSpaces = totalSpaces > 0 ? totalSpaces - availableSlotsDisplay : 0;
                            const occupancyPercent = totalSpaces > 0 ? Math.round((occupiedSpaces / totalSpaces) * 100) : 0;

                            totalSpacesEl.textContent = totalSpaces;
                            availableSpacesEl.textContent = availableSlotsDisplay;

                            occupancyPercentEl.textContent = `${occupancyPercent}%`;
                            occupancyBarEl.style.width = `${occupancyPercent}%`;

                        }
                    });

                fetch(`/get_zones/${camId}`)
                    .then(res => res.json())
                    .then(zones => {
                        zoneStatsContainer.innerHTML = '';
                        if (zones && zones.length > 0) {
                            zones.forEach(zone => {
                                const zoneName = zone.zone_name;
                                const totalZoneSpace = zone.total_spaces;
                                const availableZoneDisplay = Math.min(Math.max(zone.available_spaces, 0), totalZoneSpace);

                                const statCard = document.createElement('div');
                                statCard.className = 'bg-gray-800 rounded-xl p-6 shadow-xl';
                                    statCard.innerHTML = `
                                        <h2 class="text-lg font-semibold mb-4">
                                            <i class="fas fa-globe mr-2 mt-0.5 text-blue-400"></i>
                                            ${zoneName}
                                        </h2>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="bg-gray-700 rounded-lg p-4 text-center">
                                                <div class="text-3xl font-bold text-blue-400">${totalZoneSpace}</div>
                                                <div class="text-sm text-gray-400">Total Spaces</div>
                                            </div>
                                            <div class="bg-gray-700 rounded-lg p-4 text-center">
                                                <div class="text-3xl font-bold text-green-400">${availableZoneDisplay}</div>
                                                <div class="text-sm text-gray-400">Available</div>
                                            </div>
                                        </div>
                                    `;
                                zoneStatsContainer.appendChild(statCard);
                            });
                        } else {
                            zoneStatsContainer.innerHTML = '<div class="bg-gray-800 rounded-xl p-6 shadow-xl"><p class="text-center text-gray-500">No zones configured for this camera.</p></div>';
                        }
                    });
            }
            
            async function getDetectionType(camId) {
                try {
                    response = await fetch(`/get_detection_type/${camId}?user_id=${user.user_id}`);
                    const details = await response.json();

                    if (!response.ok) {
                        throw new Error('Failed to fetch camera detection type.')
                    }

                    return details.detection_type;

                } catch (error) {
                    console.error("Error getting detection type:", error);
                    return error;
                }
            }

            function stopStream() {
                if (currentCameraId) {
                    navigator.sendBeacon('/stop_all_streams', JSON.stringify({}));
                }
            }

            function logout() {
                stopStream();
                sessionStorage.removeItem('user');
                window.location.href = '/';
            }

            userMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                userMenu.classList.toggle('hidden');
            });
            window.addEventListener('click', () => {
                if (!userMenu.classList.contains('hidden')) userMenu.classList.add('hidden');
            });

            logoutBtn.addEventListener('click', logout);
            changeAccountBtn.addEventListener('click', logout);

            async function switchCamera(newIndex) {
                if (newIndex < 0 || newIndex >= allCameras.length) {
                    return; // Index out of bounds
                }

                if (logInterval) clearInterval(logInterval);

                currentCameraIndex = newIndex;
                const newCamera = allCameras[currentCameraIndex];
                currentCameraId = newCamera.id;

                loader.classList.remove('hidden');
                videoFeed.classList.add('hidden');
                streamStatusIndicator.innerHTML = `<div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div><span class="font-medium text-gray-400">Connecting...</span>`;

                videoFeed.onload = () => {
                    streamStatusIndicator.innerHTML = `
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2 live-indicator"></div>
                        <span class="font-medium text-green-400">Online</span>
                    `;
                };

                videoFeed.onerror = () => {
                    streamStatusIndicator.innerHTML = `
                        <div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
                        <span class="font-medium text-red-400">Error</span>
                    `;
                };

                videoFeed.src = `/video_feed/${currentCameraId}?t=${new Date().getTime()}`;
                
                camNameDisplay.textContent = newCamera.name;
                camNameDisplay.title = newCamera.name;
                cameraIdDisplayEl.textContent = currentCameraId;
                
                loader.classList.add('hidden');
                videoFeed.classList.remove('hidden');
                streamStatusIndicator.innerHTML = `<div class="w-2 h-2 bg-green-500 rounded-full mr-2 live-indicator"></div><span class="font-medium text-green-400">Online</span>`;

                detectionType = await getDetectionType(currentCameraId);
                if (detectionType === 'tripwire') {
                    detectionTypeEl.textContent = 'Tripwire Detection';
                    parkingSettings.classList.add('hidden');
                    setSpaces.classList.remove('hidden');
                } else if (detectionType === 'parking') {
                    detectionTypeEl.textContent = 'Parking Detection';
                    parkingSettings.classList.remove('hidden');
                    setSpaces.classList.add('hidden');
                } else {
                    detectionTypeEl.textContent = 'Unknown';
                }

                const newUrl = `/stream.html?camera_id=${currentCameraId}`;
                history.pushState({ path: newUrl }, '', newUrl);
                prevCamBtn.disabled = currentCameraIndex === 0;
                nextCamBtn.disabled = currentCameraIndex === allCameras.length - 1;

                fetchStats(currentCameraId);
                statsInterval = setInterval(() => fetchStats(currentCameraId), 2000);
                fetchLogs(currentCameraId);
                logInterval = setInterval(() => fetchLogs(currentCameraId), 2000);
                loadSettings(currentCameraId, detectionType);
            }

             async function initializePage() {
                try {
                    const response = await fetch(`/get_cameras/${user.user_id}`);
                    if (!response.ok) throw new Error(`Server error: ${response.status}`);
                    
                    const cameras = await response.json();
                    
                    allCameras = cameras.map(cam => ({
                        id: cam.id,
                        name: cam.camera_name || `Cam ${cam.id.substring(0, 8)}`
                    }));

                    if (allCameras.length === 0) {
                        loader.innerHTML = '<div class="text-center"><i class="fas fa-video-slash text-gray-500 text-5xl mb-4"></i><p class="text-gray-400">No cameras registered. <a href="/register_camera.html" class="text-blue-400 hover:underline">Add a camera</a> to begin.</p></div>';
                        camNameDisplay.textContent = "No Cameras";
                        [prevCamBtn, nextCamBtn, editBoundsBtn, setSpacesBtn].forEach(btn => btn.disabled = true);
                        return;
                    }

                    const urlParams = new URLSearchParams(window.location.search);
                    const requestedCameraId = urlParams.get('camera_id');
                    let startIndex = allCameras.findIndex(cam => cam.id === requestedCameraId);
                    if (startIndex === -1) startIndex = 0;
                    
                    switchCamera(startIndex);

                } catch (err) {
                    console.error("Initialization failed:", err);
                    loader.innerHTML = `<div class="text-center"><i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i><p class="text-gray-400">Error loading camera data.</p></div>`;
                    streamStatusIndicator.innerHTML = `<div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div><span class="font-medium text-red-400">Error</span>`;
                }
            }

            function fetchLogs() {
                fetch(`/get_logs/${currentCameraId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data || !Array.isArray(data.logs)) {
                            return;
                        }

                        if (data.logs.length === 0) {
                             // If there are no logs, ensure the table is empty
                             if (lastLogMessage !== "") {
                                logTbody.innerHTML = '';
                                lastLogMessage = "";
                             }
                            return;
                        }

                        const newestLogFromServer = data.logs[data.logs.length - 1];

                        // --- Only update the log table if the content has changed ---
                        if (newestLogFromServer !== lastLogMessage) {
                            lastLogMessage = newestLogFromServer;

                            logTbody.innerHTML = ''; // Clear existing logs
                            data.logs.reverse().forEach(msg => {
                                let eventType = '', eventIcon = '', iconColor = '', slotText = '--', details = '';
                                
                                // Tripwire log matching
                                if (msg.includes('ENTRY')) {
                                    eventType = 'Entry'; eventIcon = 'fa-car'; iconColor = 'text-green-400';
                                    const match = msg.match(/\[(.*?)\] (.*?) \((ENTRY)\)/);
                                    if (match) {
                                        slotText = match[2];
                                        details = `Vehicle entry detected at ${match[1]}`;
                                    }
                                } else if (msg.includes('EXIT')) {
                                    eventType = 'Exit'; eventIcon = 'fa-car-side'; iconColor = 'text-red-400';
                                    const match = msg.match(/\[(.*?)\] (.*?) \((EXIT)\)/);

                                    if (match) {
                                        slotText = match[2];
                                        details = `Vehicle exited at ${match[1]}`;
                                    }
                                } else if (msg.includes('VACATED')) {
                                    eventType = 'Vacated'; eventIcon = 'fa-car'; iconColor = 'text-green-400';
                                    const match = msg.match(/\[(.*?)\] '(.*?)' - Slot (\d+) VACATED \((.*)\)/);

                                    if (match) {
                                        slotText = `${match[2]} - Slot ${match[3]}`;
                                        details = `Slot vacated. Occupied for ${match[4]}`;
                                    }

                                } else if (msg.includes('OCCUPIED')) {
                                    eventType = 'Occupied'; eventIcon = 'fa-car-side'; iconColor = 'text-red-400';
                                    const match = msg.match(/\[(.*?)\] '(.*?)' - Slot (\d+) OCCUPIED/);

                                    if (match) {
                                        slotText = `${match[2]} - Slot ${match[3]}`;
                                        details = `Vehicle entry detected at ${match[1]}`;
                                    }
                                }

                                const timeMatch = msg.match(/\[(.*?)\]/);
                                const time = timeMatch ? timeMatch[1] : '00:00:00';

                                const logRow = document.createElement('tr');
                                logRow.className = 'hover:bg-gray-700';
                                logRow.innerHTML = `
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-center">${time}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center"><div class="inline-flex items-center"><i class="fas ${eventIcon} ${iconColor} mr-2"></i><span>${eventType}</span></div></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">${slotText}</td>
                                    <td class="px-6 py-4 text-sm text-gray-300 text-center">${details}</td>
                                `;
                                logTbody.appendChild(logRow);
                            });
                            
                            if (logTbody.firstChild) {
                                logTbody.firstChild.classList.add('new');
                                setTimeout(() => {
                                    if (logTbody.firstChild) {
                                        logTbody.firstChild.classList.remove('new');
                                    }
                                }, 1500);
                            }

                            lastUpdatedEl.textContent = new Date().toLocaleTimeString();
                        }
                    })
                    .catch(err => console.error('Error fetching logs:', err));
            }

            settingsMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                settingsMenu.classList.toggle('hidden');
            });

            window.addEventListener('click', (event) => {
                if (!settingsMenu.classList.contains('hidden') && !settingsMenuButton.contains(event.target) && !settingsMenu.contains(event.target)) {
                    settingsMenu.classList.add('hidden');
                }
            });

            // Slide Events
            detectionSlider.addEventListener('input', () => {
                detectionValue.textContent = parseFloat(detectionSlider.value).toFixed(2);
            });
            iouSlider.addEventListener('input', () => {
                iouValue.textContent = parseFloat(iouSlider.value).toFixed(2);
            });
            confirmationSlider.addEventListener('input', () => {
                confirmationValue.textContent = confirmationSlider.value;
            });


            function loadSettings(camId, detectionType) {
                if (!camId) return;
                fetch(`/get_settings/${camId}?user_id=${user.user_id}`)
                    .then(res => res.json())
                    .then(settings => {
                        detectionSlider.value = settings.detection_threshold;
                        detectionValue.textContent = parseFloat(settings.detection_threshold).toFixed(2);

                        if (detectionType === 'parking') {
                            iouSlider.value = settings.iou_threshold || 0.3;
                            iouValue.textContent = parseFloat(iouSlider.value).toFixed(2);
                            confirmationSlider.value = settings.confirmation_time || 10;
                            confirmationValue.textContent = confirmationSlider.value;
                        }
                    });
            }

            saveSettingsBtn.addEventListener('click', () => {
                if (!currentCameraId) {
                    return;
                }
                settingsStatus.textContent = 'Saving...';

                const settings = {
                    user_id: user.user_id,
                    detection_threshold: parseFloat(detectionSlider.value)
                };

                if (detectionType === 'parking') {
                    settings.iou_threshold = parseFloat(iouSlider.value);
                    settings.confirmation_time = parseInt(confirmationSlider.value, 10);
                }

                fetch(`/save_settings/${currentCameraId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        settingsStatus.textContent = 'Settings saved successfully!';
                        setTimeout(() => settingsStatus.textContent = '', 2000);
                    } else {
                        settingsStatus.textContent = 'Error saving settings.';
                    }
                });
            });

            deleteCamBtn.addEventListener('click', () => {
                if (!currentCameraId) return;

                if (confirm('Are you sure you want to permanently delete this camera and all its data? This action cannot be undone.')) {
                    stopStream();

                    fetch(`/delete_camera/${currentCameraId}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ user_id: user.user_id })
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert('Camera deleted successfully.');
                            window.location.href = '/register_camera.html'
                        } else {
                            alert(`Error: ${result.error || 'Failed to delete camera.'}`);
                        }
                    })
                    .catch(err => {
                        console.error('Delete error:', err);
                        alert('An error occurred while trying to delete the camera.');
                    });
                }
            });

            // --- Main Execution ---
            initializePage();

            // --- Event Listeners ---
            editBoundsBtn.addEventListener('click', () => {
                if (currentCameraId) {
                    window.location.href = `/picker.html?camera_id=${currentCameraId}`;
                }
            });

            setSpacesBtn.addEventListener('click', () => {
                if (currentCameraId) {
                    window.location.href = `/set_spaces.html`;
                }
            });

            prevCamBtn.addEventListener('click', () => switchCamera(currentCameraIndex - 1));
            nextCamBtn.addEventListener('click', () => switchCamera(currentCameraIndex + 1));

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && currentCameraId) {
                    videoFeed.src = `/video_feed/${currentCameraId}?t=${new Date().getTime()}`;
                }
            });
        });
    </script>
</body>
</html>